<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/jpeg" href="logo.png">

  <title>‚öôÔ∏è Param√®tres</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 40px;
      background: #f7f9fc;
      color: #2c3e50;
    }
    h1 {
      text-align: center;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .section h2 {
      margin-top: 0;
    }
    input[type="text"] {
      padding: 8px;
      margin: 5px 0 10px;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 8px;
    }
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-add {
      background: #2ecc71;
      color: white;
    }
    .btn-del {
      background: #e74c3c;
      color: white;
      margin-left: 8px;
    }

    /* Modale */
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      min-width: 300px;
      max-width: 90%;
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-actions {
      text-align: right;
      margin-top: 20px;
    }
    .modal-actions button {
      margin-left: 10px;
    }
	#bubble-container {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
  align-items: flex-end;
}
	.bubble {
  max-width: 300px;
  padding: 10px 15px;
  border-radius: 8px;
  color: white;
  font-family: sans-serif;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  animation: fadeout 0.5s ease-in-out 1.5s forwards;
  word-wrap: break-word;
  text-align: left;
}

.administratif {
  background-color: #2196F3; /* bleu */
}

.alerte {
  background-color: #f44336; /* rouge */
}

@keyframes fadeout {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}
.blur {
  filter: blur(10px);
  pointer-events: none;
  user-select: none;
}

#passwordModal {
  display: flex;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

#passwordModal .modal-content {
  max-width: 400px;
}
/* ‚úèÔ∏è Boutons d‚Äô√©dition */
.btn-edit {
  background: transparent;
  border: none;
  font-size: 18px;
  margin-left: 8px;
  cursor: pointer;
  color: #0078d4;
  transition: transform 0.2s, color 0.2s;
}
.btn-edit:hover {
  color: #005ea2;
  transform: scale(1.2);
}

/* üîí Modale de code */
#modalCode {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.55);
  z-index: 99999; /* üß© priorit√© max */
  justify-content: center;
  align-items: center;
}

#modalCode .modal-content {
  background: #ffffff;
  border-radius: 12px;
  padding: 25px;
  width: 90%;
  max-width: 380px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  animation: popIn 0.25s ease;
  border-top: 5px solid #0078d4;
  text-align: center;
}

#modalCode input[type="text"] {
  width: 100%;
  padding: 10px 14px;
  border-radius: 8px;
  border: 1px solid #ccd6e0;
  font-size: 1rem;
  margin-top: 10px;
}

#modalCode input:focus {
  border-color: #0078d4;
  box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.25);
  outline: none;
}

@keyframes popIn {
  from { transform: scale(0.95); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
/* üîΩ Accord√©on */
.section-title {
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.section-title::after {
  content: "‚ñæ";
  font-size: 18px;
  transition: transform 0.25s ease;
}

.section.collapsed .section-title::after {
  transform: rotate(-90deg);
}

.section-content {
  margin-top: 15px;
}

.section.collapsed .section-content {
  display: none;
}
#shell-topbar{
  position:fixed;top:0;left:0;right:0;height:64px;
  background:#ffffff;display:flex;flex-direction:column;
  padding:6px 14px;z-index:10000;box-shadow:0 4px 16px rgba(0,0,0,.12)
}

#actions{
  display:flex;gap:10px;align-items:center
}

.action-btn{
  background:#e6f0fc;
  border:none;
  border-radius:12px;
  padding:8px 14px;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.action-btn:hover{background:#0078d4;color:white}
#shell-topbar {
  display: flex;
  flex-direction: column;
  padding: 6px 14px;
}

#topbar-left, #topbar-right {
  display: flex;
  align-items: center;
}

#topbar-left {
  position: absolute;
  left: 14px;
  top: 10px;
  font-weight: bold;
  font-size: 20px;
}

#topbar-right {
  position: absolute;
  right: 14px;
  top: 10px;
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}
#shell-topbar {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: 64px;
  background: #ffffff;
  padding: 6px 14px;
  box-shadow: 0 4px 16px rgba(0,0,0,.12);
  display: flex;
  flex-direction: column;
  z-index: 10000;
}

#topbar-main {
  display: flex;
  align-items: center;
  justify-content: space-between; /* Titre √† gauche, actions au centre, date √† droite */
  gap: 10px;
}

#app-title {
  font-weight: bold;
  font-size: 20px;
}
#topbar-center {
  font-size: 16px;
  font-weight: 500;
}

#actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap; /* pour les √©crans plus petits */
  justify-content: center; /* centre les boutons */
}

#datetime {
  font-weight: 500;
  font-size: 14px;
  color: #374151;
}
body {
  font-family: "Segoe UI", sans-serif;
  margin: 40px 40px 0 40px; /* on garde le margin lat√©ral, mais top sera ajust√© par padding-top */
  padding-top: 80px; /* espace pour la barre fixe de 64px + un peu de marge */
  background: #f7f9fc;
  color: #2c3e50;
}

  </style>
</head>
<body>

<div id="content">


<div id="shell-topbar">
  <div id="topbar-main">
    <span id="app-title">üöë GestUrg2</span>

    <div id="actions">
      <button class="action-btn" onclick="window.location.href='admin.html'">Gestion des comptes</button>


  </div>
<div id="topbar-center">
    ‚öôÔ∏è Param√®tres
  </div>

      <button class ="action-btn" onclick="window.location.href='index.html'">üîì Deconnexion administrateurs</button>

    

 <div id="right-container">
    <div id="window-controls" style="display:none;">
      <button onclick="electronMinimize()">‚Äî</button>
      <button onclick="electronMaximize()">‚òê</button>
      <button class="close" onclick="electronClose()">‚úï</button>
    </div>
    <span id="datetime"></span>
    <div id="nom-medecin"></div>
  

  
</div>
</div>
</div>

  <div class="section collapsed">
  <h2 class="section-title">
    ü©∫ Actes
  </h2>
  <div class="section-content">
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('actes')">‚ûï Ajouter</button>

    <ul id="actesList"></ul>
  </div>
</div>


 <div class="section collapsed">
  <h2 class="section-title">
    üë®‚Äç‚öïÔ∏è Personnel
  </h2>
  <div class="section-content">
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('personnel')">‚ûï Ajouter</button>

    <ul id="personnelList"></ul>
  </div>
</div>

<div class="section collapsed">
  <h2 class="section-title">
    üè• Services
  </h2>
  <div class="section-content">
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('sp√©cialit√©s')">‚ûï Ajouter</button>

    <ul id="sp√©cialit√©sList"></ul>
  </div>
</div>

<div class="section collapsed">
  <h2 class="section-title">
    üí∂ Facturables
  </h2>
  <div class="section-content">
    <button class="btn btn-add" onclick="event.stopPropagation(); openFacturableModal()">‚ûï Ajouter</button>

    <ul id="facturablesList"></ul>
  </div>
</div>
<div class="section collapsed">
  <h2 class="section-title">
    üöë Moyens
  </h2>
  <div class="section-content">
    <button class="btn btn-add" onclick="event.stopPropagation(); openModal('moyens')">‚ûï Ajouter</button>

    <ul id="moyensList"></ul>
  </div>
</div>

<!-- Modale sp√©cifique pour les facturables -->
<div class="modal" id="modalFacturable">
  <div class="modal-content">
    <h3>‚ûï Ajouter un Facturable</h3>
    <input type="text" id="facturableName" placeholder="Nom du facturable..." />
    <input type="number" id="facturablePrice" placeholder="Prix (sans ‚Ç¨)" style="margin-top: 10px;" />
    <div class="modal-actions">
      <button class="btn" onclick="cancelFacturableModal()">‚ùå Annuler</button>
      <button class="btn btn-add" onclick="confirmFacturable()">‚úÖ Valider</button>
    </div>
  </div>
</div>

<!-- üîê Codes d‚Äôacc√®s -->
<div class="section collapsed">
  <h2 class="section-title">üîí Codes d‚Äôacc√®s</h2>

  <div class="section-content">
    <p>
      <strong>üßæ Code de Cl√¥ture d‚ÄôHospitalisation (CCH) :</strong>
      <span id="afficheCCH">.......</span>
      <button class="btn-edit" id="btnEditCCH">‚úèÔ∏è</button>
    </p>

    <p>
      <strong>‚öôÔ∏è Code d‚ÄôAcc√®s Administratif (CAA) :</strong>
      <span id="afficheCAA">.......</span>
      <button class="btn-edit" id="btnEditCAA">‚úèÔ∏è</button>
    </p>
  </div>
</div>


<!-- ü™ü Modale pour modifier un code -->
<div class="modal" id="modalCode">
  <div class="modal-content">
    <h3 id="titreCode">Modifier le code</h3>
    <input type="text" id="inputCode" placeholder="Nouveau code..." />
    <div class="modal-actions">
      <button class="btn" id="btnAnnulerCode">‚ùå Annuler</button>
      <button class="btn btn-add" id="btnValiderCode">‚úÖ Valider</button>
    </div>
  </div>
</div>
<div class="section collapsed">
  <h2 class="section-title">
    üí¨ Messages d‚Äôaccueil
  </h2>
  <div class="section-content">
    <button class="btn btn-add" onclick="event.stopPropagation(); openAddMessageModal()">‚ûï Ajouter</button>

    <ul id="messagesAccueilList"></ul>
  </div>
</div>


<!-- MODALE AJOUT -->
<div class="modal" id="modalAddMessage">
  <div class="modal-content">
    <h3>‚ûï Ajouter un message d‚Äôaccueil</h3>
    <input type="text" id="newMessageTitle" placeholder="Titre..." />
    <select id="newMessageType" style="margin-top:10px;">
      <option value="info">Info</option>
      <option value="alerte_grave">Alerte grave</option>
      <option value="alerte_moyenne">Alerte moyenne</option>
      <option value="remerciement">Remerciement</option>
    </select>
    <input type="text" id="newMessageText1" placeholder="Texte 1..." />
    <input type="text" id="newMessageText2" placeholder="Texte 2..." />
    <div class="modal-actions">
      <button class="btn" onclick="cancelAddMessageModal()">‚ùå Annuler</button>
      <button class="btn btn-add" onclick="confirmAddMessage()">‚úÖ Valider</button>
    </div>
  </div>
</div>

<!-- MODALE EDIT -->
<div class="modal" id="modalEditMessage">
  <div class="modal-content">
    <h3>‚úèÔ∏è Modifier le message</h3>
    <input type="text" id="editMessageTitle" placeholder="Titre..." />
    <select id="editMessageType" style="margin-top:10px;">
      <option value="info">Info</option>
      <option value="alerte_grave">Alerte grave</option>
      <option value="alerte_moyenne">Alerte moyenne</option>
      <option value="remerciement">Remerciement</option>
    </select>
    <input type="text" id="editMessageText1" placeholder="Texte 1..." />
    <input type="text" id="editMessageText2" placeholder="Texte 2..." />
    <div class="modal-actions">
      <button class="btn" onclick="cancelEditMessageModal()">‚ùå Annuler</button>
      <button class="btn btn-add" onclick="confirmEditMessage()">‚úÖ Valider</button>
    </div>
  </div>
</div>
<div class="section collapsed">
  <h2 class="section-title">üè¢ Module de gestion des bureaux</h2>

  <div class="section-content">

    <label style="display:flex;align-items:center;gap:10px;margin-bottom:15px;">
      <strong>Activer le module :</strong>
      <input type="checkbox" id="toggleBureaux">
    </label>

    <div id="sectionBureaux" style="display:none;">
      <button class="btn btn-add" onclick="event.stopPropagation(); openModalBureau()">‚ûï Ajouter</button>
      <ul id="bureauxList"></ul>
    </div>

  </div>
</div>


</section>

 <div class="section collapsed">
  <h2 class="section-title">üßπ Nettoyage et maintenance</h2>

  <div class="section-content">
    <p>
      Cette section vous permet de g√©rer le nettoyage automatique des anciens rapports
      et documents stock√©s sur le serveur.
    </p>

    <div style="text-align:center; margin-top:20px;">
      <button id="btnNettoyage">üîó Ouvrir l‚Äôoutil de nettoyage</button>
    </div>
  </div>
</div>

<div class="section collapsed">
  <h2 class="section-title">üì∫ Afficheur salle d‚Äôattente</h2>

  <div class="section-content">
    <p>
      Ouvre l‚Äôafficheur patient avec les donn√©es issues des fiches patients
      (salle d‚Äôattente, urgences vitales, etc.).
    </p>

    <div style="text-align:center; margin-top:20px;">
      <button id="btnAfficheur">üîó Ouvrir l‚Äôafficheur</button>
    </div>
  </div>
</div>



<!-- Modale sp√©cifique pour cr√©er/modifier un bureau -->
<div class="modal" id="modalBureau">
  <div class="modal-content">
    <h3>‚ûï Ajouter un Bureau</h3>
    <input type="text" id="bureauNameInput" placeholder="Nom du bureau..." />
    <div class="modal-actions">
      <button class="btn" onclick="cancelModalBureau()">‚ùå Annuler</button>
      <button class="btn btn-add" onclick="confirmModalBureau()">‚úÖ Valider</button>
    </div>
  </div>
</div>

  <!-- MODALE -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitle">‚ûïAjouter</h3>
      <input type="text" id="modalInput" placeholder="Nom..." />
      <div class="modal-actions">
        <button class="btn" onclick="cancelModal()">‚ùå Annuler</button>
        <button class="btn btn-add" onclick="confirmModal()">‚úÖ Valider</button>
      </div>
    </div>
  </div>
</div>
  <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // --- Configuration Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBKp5-7NNy0Gyl0tNbDgD-BxucYdg8ArWo",
    authDomain: "urgences-a8ed4.firebaseapp.com",
    projectId: "urgences-a8ed4",
  };

  // --- Initialisation unique ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  console.log("‚úÖ Firebase initialis√© :", app.name);


onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "connexionadmin.html";
    return;
  }

  const ref = doc(db, "medecins", user.uid);
  const snap = await getDoc(ref);
  const data = snap.data();

  if (!data?.pages?.admin) {
    alert("Acc√®s r√©serv√© aux administrateurs.");
    window.location.href = "index.html";
  }
});



const actesListEl = document.getElementById('actesList');
const moyensListEl = document.getElementById('moyensList');

const personnelListEl = document.getElementById('personnelList');
let actes = [];
let moyens = [];
let personnel = [];
let sp√©cialit√©s = [];
let currentType = null;

async function saveToFirestore() {
  try {

    await setDoc(doc(db, "r√©f√©rentiels", "actes"), { liste: actes });
    await setDoc(doc(db, "r√©f√©rentiels", "personnel"), { liste: personnel });
    await setDoc(doc(db, "r√©f√©rentiels", "sp√©cialit√©s"), { sp√©cialit√©s });


    afficherBulle("‚úÖ Donn√©es enregistr√©es avec succ√®s", "administratif");
  } catch (error) {
    console.error("Erreur lors de l'enregistrement :", error);
    afficherBulle("‚ùå √âchec de l'enregistrement", "alerte");
  }
}
const toggleBureaux = document.getElementById("toggleBureaux");
let bureauGeneralActive = false;

async function loadData() {
  

  const actesSnap = await getDoc(doc(db, "r√©f√©rentiels", "actes"));
  actes = actesSnap.exists() ? actesSnap.data().liste || [] : [];
  renderList("actes", actes);

  const persSnap = await getDoc(doc(db, "r√©f√©rentiels", "personnel"));
  personnel = persSnap.exists() ? persSnap.data().liste || [] : [];
  renderList("personnel", personnel);
  
  const sp√©cialit√©sSnap = await getDoc(doc(db, "r√©f√©rentiels", "sp√©cialit√©s"));
sp√©cialit√©s = sp√©cialit√©sSnap.exists() ? sp√©cialit√©sSnap.data().sp√©cialit√©s || [] : [];
  renderList("sp√©cialit√©s", sp√©cialit√©s);
}

function renderList(type, array) {
const container = type === "actes" ? actesListEl : type === "moyens" ? moyensListEl : type === "sp√©cialit√©s" ? document.getElementById("sp√©cialit√©sList") : personnelListEl;
  container.innerHTML = "";
  array.forEach((item, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<input value="${item.replace(/"/g, '&quot;')}" onchange="updateItem('${type}', ${index}, this.value)" />
                    <button class="btn btn-del" onclick="removeItem('${type}', ${index})">‚ùå</button>`;
    container.appendChild(li);
  });
}
 document.getElementById("btnNettoyage").addEventListener("click", () => {
    window.location.href = "nettoyage.html";
  });
   document.getElementById("btnAfficheur").addEventListener("click", () => {
    window.location.href = "afficheur-patient.html";
  });
window.updateItem = async (type, index, newValue) => {
    if (type === "moyens") moyens[index] = newValue;
  if (type === "actes") actes[index] = newValue;
  if (type === "personnel") personnel[index] = newValue;
  if (type === "sp√©cialit√©s") sp√©cialit√©s[index] = newValue;
 
  await saveToFirestore();
};

window.removeItem = async (type, index) => {
    if (type === "moyens") moyens.splice(index, 1);
  if (type === "actes") actes.splice(index, 1);
  if (type === "personnel") personnel.splice(index, 1);
  if (type === "sp√©cialit√©s") sp√©cialit√©s.splice(index, 1);
  renderList(type, type === "actes" ? actes : type === "sp√©cialit√©s" ? sp√©cialit√©s : personnel);
  await saveToFirestore();
};

window.openModal = (type) => {
  currentType = type;
  document.getElementById("modalTitle").textContent = `‚ûï Ajouter √† ${type}`;
  document.getElementById("modalInput").value = "";
  document.getElementById("modal").style.display = "flex";
};

window.confirmModal = async () => {
  const val = document.getElementById("modalInput").value.trim();
  if (!val) return;
    if (currentType === "moyens") moyens.push(val);
  if (currentType === "actes") actes.push(val);
  if (currentType === "personnel") personnel.push(val);
    if (currentType === "sp√©cialit√©s") sp√©cialit√©s.push(val);
  renderList(currentType, currentType === "actes" ? actes : currentType === "sp√©cialit√©s" ? sp√©cialit√©s : personnel);
  document.getElementById("modal").style.display = "none";
  await saveToFirestore();
};

window.cancelModal = async () => {
  document.getElementById("modal").style.display = "none";
  await saveToFirestore();
};

/* ---------------- FACTURABLES ---------------- */
const facturablesListEl = document.getElementById("facturablesList");
let facturables = {}; // objet { nom: prix }

async function loadFacturables() {
  try {
    const snap = await getDoc(doc(db, "r√©f√©rentiels", "Facturables"));
    facturables = snap.exists() ? snap.data() : {};
    renderFacturables();
  } catch (err) {
    console.error("Erreur chargement facturables :", err);
  }
}

function renderFacturables() {
  facturablesListEl.innerHTML = "";
  const entries = Object.entries(facturables);
  if (entries.length === 0) {
    facturablesListEl.innerHTML = "<li>Aucun facturable pour le moment</li>";
    return;
  }

  entries.forEach(([nom, prix]) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${nom}</strong> ‚Äî <input type="number" value="${prix}" 
        onchange="updateFacturablePrice('${nom}', this.value)" style="width:80px;" /> ‚Ç¨
      <button class="btn btn-del" onclick="deleteFacturable('${nom}')">‚ùå</button>
    `;
    facturablesListEl.appendChild(li);
  });
}

window.openFacturableModal = () => {
  document.getElementById("modalFacturable").style.display = "flex";
  document.getElementById("facturableName").value = "";
  document.getElementById("facturablePrice").value = "";
};

window.cancelFacturableModal = () => {
  document.getElementById("modalFacturable").style.display = "none";
};

window.confirmFacturable = async () => {
  const name = document.getElementById("facturableName").value.trim();
  const price = parseFloat(document.getElementById("facturablePrice").value.trim());
  if (!name || isNaN(price)) {
    afficherBulle("‚ö†Ô∏è Nom ou prix invalide", "alerte");
    return;
  }

  facturables[name] = price;
  await saveFacturables();
  renderFacturables();
  document.getElementById("modalFacturable").style.display = "none";
};

window.updateFacturablePrice = async (nom, newPrice) => {
  facturables[nom] = parseFloat(newPrice) || 0;
  await saveFacturables();
};

window.deleteFacturable = async (nom) => {
  delete facturables[nom];
  await saveFacturables();
  renderFacturables();
};

async function saveFacturables() {
  try {
    await setDoc(doc(db, "r√©f√©rentiels", "Facturables"), facturables);
    afficherBulle("‚úÖ Facturables enregistr√©s", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement facturables :", err);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "alerte");
  }
}

// Charger les facturables au d√©marrage
loadFacturables();
const sectionBureaux = document.getElementById("sectionBureaux");
const bureauxListEl = document.getElementById("bureauxList");
let bureaux = {}; // objet { nomBureau: {agentEmail:null, agentUid:null, connecte:false, connexionAt:null} }
let editingBureau = null;

// üîπ Charger l'√©tat g√©n√©ral et les bureaux
async function loadBureaux() {
  const ref = doc(db, "r√©f√©rentiels", "bureau");
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const data = snap.data();

    bureauGeneralActive = data.general?.active ?? false;
    toggleBureaux.checked = bureauGeneralActive;
    sectionBureaux.style.display = bureauGeneralActive ? "block" : "none";

    bureaux = { ...data };
    delete bureaux.general;

    renderBureaux();
  }
}
toggleBureaux.addEventListener("change", async () => {
  bureauGeneralActive = toggleBureaux.checked;
  sectionBureaux.style.display = bureauGeneralActive ? "block" : "none";
  await saveBureaux();
});


function renderBureaux() {
  bureauxListEl.innerHTML = "";
  Object.entries(bureaux).forEach(([nom, info]) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <input value="${nom.replace(/"/g,'&quot;')}" onchange="updateBureauName('${nom}', this.value)" />
      <button class="btn btn-del" onclick="deleteBureau('${nom}')">‚ùå</button>
    `;
    bureauxListEl.appendChild(li);
  });
}

// --- Ajouter un nouveau bureau ---
window.openModalBureau = () => {
  editingBureau = null;
  document.getElementById("bureauNameInput").value = "";
  document.getElementById("modalBureau").style.display = "flex";
};

window.cancelModalBureau = () => {
  document.getElementById("modalBureau").style.display = "none";
};

window.confirmModalBureau = async () => {
  const name = document.getElementById("bureauNameInput").value.trim();
  if (!name) return;

  if (!bureaux[name]) {
    bureaux[name] = { agentEmail: null, agentUid: null, connecte: false, connexionAt: null };
  }

  await saveBureaux();
  renderBureaux();
  document.getElementById("modalBureau").style.display = "none";
};

// --- Modifier le nom d'un bureau ---
window.updateBureauName = async (oldName, newName) => {
  if (!newName || oldName === newName) return;
  bureaux[newName] = bureaux[oldName];
  delete bureaux[oldName];
  await saveBureaux();
  renderBureaux();
};

// --- Supprimer un bureau ---
window.deleteBureau = async (name) => {
  delete bureaux[name];
  await saveBureaux();
  renderBureaux();
};

// --- Sauvegarde Firestore ---
async function saveBureaux() {
  try {
    await setDoc(doc(db, "r√©f√©rentiels", "bureau"), {
      ...bureaux,
      general: { active: bureauGeneralActive }
    });

    afficherBulle("‚úÖ Param√®tres bureaux enregistr√©s", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement bureaux :", err);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "alerte");
  }
}


// Charger au d√©marrage
loadBureaux();


function afficherBulle(texte, type) {
  let container = document.getElementById('bubble-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'bubble-container';
    container.style.position = "fixed";
    container.style.top = "20px";
    container.style.right = "20px";
    container.style.zIndex = "9999";
    document.body.appendChild(container);
  }
  const bulle = document.createElement('div');
  bulle.className = `bubble ${type}`;
  bulle.textContent = texte;
  bulle.style.backgroundColor = type === "administratif" ? "#3498db" : "#e74c3c";
  bulle.style.color = "white";
  bulle.style.padding = "10px 15px";
  bulle.style.marginBottom = "10px";
  bulle.style.borderRadius = "6px";
  bulle.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
  bulle.style.transition = "opacity 0.4s ease";
  container.appendChild(bulle);
  setTimeout(() => {
    bulle.style.opacity = "0";
    setTimeout(() => bulle.remove(), 400);
  }, 2500);
}
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    cancelModal();
  }
});

loadData();


  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "accueil.html";
    } else {
      const docSnap = await getDoc(doc(db, "medecins", user.uid));
      if (docSnap.exists()) {
        const data = docSnap.data();
        document.getElementById("nom-medecin").textContent = data.nom || "M√©decin";

      }
    }
  });
  
let medecinNom = "";
  let medecinSpecialite = "";
  let medecinLieu = "";

  onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
  } else {
    try {
      const docRef = doc(db, "medecins", user.uid);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        const medecinNom = data.nom || "";
        const medecinSpecialite = data.specialite || "";
        const medecinLieu = data.lieu || "";

        // Met √† jour aussi les variables globales sur window
        window.medecinNom = medecinNom;
        window.medecinSpecialite = medecinSpecialite;
        window.medecinLieu = medecinLieu;

        // Mise √† jour des √©l√©ments HTML si pr√©sents
        const nomElem = document.getElementById("nom-medecin");
        if (nomElem) nomElem.textContent = medecinNom;

        const specElem = document.getElementById("specialite");
        if (specElem) specElem.textContent = medecinSpecialite;


        // --- V√©rification d'acc√®s √† la page ---
        const pages = data.pages || {};
        const currentPath = window.location.pathname;
        const currentPage = currentPath.substring(currentPath.lastIndexOf("/") + 1).replace(".html", "");

        if (!pages[currentPage]) {
          alert("‚õîÔ∏è Vous n‚Äôavez pas acc√®s √† cette page.");
          window.location.href = "index.html";
          return; // Stoppe le script ici
        }
      } else {
        // Document inexistant ‚Äî redirection
        alert("Utilisateur non trouv√©, veuillez vous reconnecter.");
        window.location.href = "accueil.html";
      }
    } catch (error) {
      console.error("Erreur chargement m√©decin :", error);
      alert("Une erreur est survenue, veuillez r√©essayer plus tard.");
    }
  }
});
// --- GESTION CCH & CAA ---
const docPatientRef = doc(db, "patients", "QhwMJ0mjmUnS8MTNBCFU");
const spanCCH = document.getElementById("afficheCCH");
const spanCAA = document.getElementById("afficheCAA");
const modalCode = document.getElementById("modalCode");
const titreCode = document.getElementById("titreCode");
const inputCode = document.getElementById("inputCode");
const btnAnnulerCode = document.getElementById("btnAnnulerCode");
const btnValiderCode = document.getElementById("btnValiderCode");

let codeType = null;

// üîπ Charger les codes
async function chargerCodes() {
  const snap = await getDoc(docPatientRef);
  if (snap.exists()) {
    const data = snap.data();
    spanCCH.textContent = data.CCH ? "......." : "Non d√©fini";
    spanCAA.textContent = data.CAA ? "......." : "Non d√©fini";
  }
}
chargerCodes();

// üîπ Ouvrir la modale
document.getElementById("btnEditCCH").addEventListener("click", () => {
  codeType = "CCH";
  titreCode.textContent = "Modifier le CCH";
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

document.getElementById("btnEditCAA").addEventListener("click", () => {
  codeType = "CAA";
  titreCode.textContent = "Modifier le CAA";
  inputCode.value = "";
  modalCode.style.display = "flex";
  inputCode.focus();
});

// üîπ Fermer la modale
btnAnnulerCode.addEventListener("click", () => {
  modalCode.style.display = "none";
});

// üîπ Valider la modification
btnValiderCode.addEventListener("click", async () => {
  const newCode = inputCode.value.trim();
  if (!newCode) {
    afficherBulle("‚ö†Ô∏è Entrez un code valide", "alerte");
    return;
  }
  try {
    await setDoc(docPatientRef, { [codeType]: newCode }, { merge: true });
    afficherBulle(`‚úÖ ${codeType} mis √† jour`, "administratif");
    modalCode.style.display = "none";
    chargerCodes();
  } catch (e) {
    console.error("Erreur mise √† jour code :", e);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "alerte");
  }
});
// ---------------- MESSAGES D'ACCUEIL ----------------
const messagesAccueilListEl = document.getElementById("messagesAccueilList");
let messagesAccueil = [];
let editingIndex = null;

async function loadMessagesAccueil() {
  try {
    const snap = await getDoc(doc(db, "r√©f√©rentiels", "messages_accueil"));
    messagesAccueil = snap.exists() ? snap.data().liste || [] : [];
    renderMessagesAccueil();
  } catch (err) {
    console.error("Erreur chargement messages accueil :", err);
  }
}

function renderMessagesAccueil() {
  messagesAccueilListEl.innerHTML = "";
  messagesAccueil.forEach((msg, index) => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${msg.titre}</strong> [${msg.type}]<br/>
      ${msg.texte1}<br/>
      ${msg.texte2}<br/>
      <button class="btn btn-edit" onclick="openEditMessageModal(${index})">‚úèÔ∏è</button>
      <button class="btn btn-del" onclick="deleteMessage(${index})">‚ùå</button>
    `;
    messagesAccueilListEl.appendChild(li);
  });
}

// --- Ajouter message ---
window.openAddMessageModal = () => {
  document.getElementById("newMessageTitle").value = "";
  document.getElementById("newMessageType").value = "info";
  document.getElementById("newMessageText1").value = "";
  document.getElementById("newMessageText2").value = "";
  document.getElementById("modalAddMessage").style.display = "flex";
};

window.cancelAddMessageModal = () => {
  document.getElementById("modalAddMessage").style.display = "none";
};

window.confirmAddMessage = async () => {
  const titre = document.getElementById("newMessageTitle").value.trim();
  const type = document.getElementById("newMessageType").value;
  const texte1 = document.getElementById("newMessageText1").value.trim();
  const texte2 = document.getElementById("newMessageText2").value.trim();
  if (!titre) { afficherBulle("‚ö†Ô∏è Le titre est requis", "alerte"); return; }
  messagesAccueil.push({ titre, type, texte1, texte2 });
  await saveMessagesAccueil();
  renderMessagesAccueil();
  cancelAddMessageModal();
};

// --- √âditer message ---
window.openEditMessageModal = (index) => {
  editingIndex = index;
  const msg = messagesAccueil[index];
  document.getElementById("editMessageTitle").value = msg.titre;
  document.getElementById("editMessageType").value = msg.type;
  document.getElementById("editMessageText1").value = msg.texte1;
  document.getElementById("editMessageText2").value = msg.texte2;
  document.getElementById("modalEditMessage").style.display = "flex";
};

window.cancelEditMessageModal = () => {
  document.getElementById("modalEditMessage").style.display = "none";
};

window.confirmEditMessage = async () => {
  const titre = document.getElementById("editMessageTitle").value.trim();
  const type = document.getElementById("editMessageType").value;
  const texte1 = document.getElementById("editMessageText1").value.trim();
  const texte2 = document.getElementById("editMessageText2").value.trim();
  if (!titre) { afficherBulle("‚ö†Ô∏è Le titre est requis", "alerte"); return; }
  messagesAccueil[editingIndex] = { titre, type, texte1, texte2 };
  await saveMessagesAccueil();
  renderMessagesAccueil();
  cancelEditMessageModal();
};

// --- Supprimer message ---
window.deleteMessage = async (index) => {
  messagesAccueil.splice(index, 1);
  await saveMessagesAccueil();
  renderMessagesAccueil();
};

// --- Sauvegarde Firestore ---
async function saveMessagesAccueil() {
  try {
    await setDoc(doc(db, "r√©f√©rentiels", "messages_accueil"), { liste: messagesAccueil });
    afficherBulle("‚úÖ Messages d‚Äôaccueil enregistr√©s", "administratif");
  } catch (err) {
    console.error("Erreur enregistrement messages :", err);
    afficherBulle("‚ùå Erreur d‚Äôenregistrement", "alerte");
  }
}

document.querySelectorAll(".section-title").forEach(title => {
  title.addEventListener("click", () => {
    title.parentElement.classList.toggle("collapsed");
  });
});

function updateDateTime() {
  const now = new Date();
  const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
  const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('datetime').textContent = now.toLocaleDateString('fr-FR', options) + ' ' + time;
}
setInterval(updateDateTime, 1000);
updateDateTime();
// Charger les messages au d√©marrage
loadMessagesAccueil();



</script>
</body>
</html>

